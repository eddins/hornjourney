{{ define "main" }}
  {{ if eq .Section "post" }}
    {{ if and (.PrevPage) (eq .PrevPage.Section "post") }}
      <span id="prev-link">
        <a href="{{ .PrevPage.Permalink }}">
          &laquo; {{ .PrevPage.Title | truncate 20 "..." }}
        </a>
      </span>
    {{ end }}
    {{ if and (.NextPage) (eq .NextPage.Section "post") }}
      <span id="next-link">
        <a href="{{ .NextPage.Permalink }}">
          {{ .NextPage.Title | truncate 20 "..." }} &raquo;
        </a>
      </span>
    {{ end }}
  {{ end }}
  <h1><span class="title">{{ .Title | markdownify }}</span></h1>
  {{ if eq .Section "post" }}
    <p>
      <span class="byline">{{ .Site.Params.author }}</span>
    </p>
    {{ $show_posted_date := gt .Date 0 }}
    {{ if $show_posted_date }}
      <p class="date-info">Posted on {{ .Date.Format .Site.Params.dateFormat }}</p>
    {{ end }}
  {{ else if eq .Title "Now" }}
    <p class="date-info">Updated on {{ .Lastmod.Format .Site.Params.dateFormat }}</p>
  {{ end }}

  <main>
    {{ .Content }}
  </main>
  
   {{ if eq .Section "post" }}
    <hr/>
    <section class="staticman-comments">

      {{ $slug := replace .RelPermalink "/" "-" }}
      {{ $this_post_comments := slice }}
      {{ range .Site.Data.comments }}
        {{ if eq .post $slug }}
          {{ $this_post_comments = $this_post_comments | append . }}
        {{ end }}
      {{ end }}
      {{ $num_comments := len $this_post_comments }}
      {{ if eq $num_comments 0 }}
        <h3>No comments</h3>
      {{ else }}
        {{ if eq $num_comments 1 }}
          <h3>1 comment</h3>
        {{ else }}
          <h3>{{ $num_comments }} comments</h3>
        {{ end }}
      {{ end }}
      
      {{ range sort $this_post_comments "date" "desc" }}
        <p>
          <span class="comment-name">{{ .name }}</span>
          <time datetime="{{ .date }}">
            {{ dateFormat (default "on Jan 2, 2006 at 15:04:05" .Site.Params.dateformat) .date}}
          </time>
        </p>
        <p class="comment-content">
          {{ .message | markdownify }}
        </p>
      {{ end }}
        
      <h3>Add a comment</h3>
      <form class="js-form form" method="post" action="/.netlify/functions/staticman?branch=main">
        <input type="hidden" name="fields[post]" value="{{ replace .RelPermalink "/" "-" }}">
        <input type="hidden" name="options[redirect]" value="/comment-thank-you">
        <input type="hidden" name="options[redirectError]" value="/comment-error">
        <input type="hidden" name="options[parent]" value="">

        <fieldset>
          <div class="textfield">
            <input name="fields[name]" type="text" placeholder="Your name"/>
          </div>
        </fieldset>

        <fieldset>
          <div class="textfield">
            <textarea name="fields[message]" placeholder="Your comment (use Markdown syntax if you wish)"
              rows="5" cols="40"></textarea>
          </div>
        </fieldset>

        <fieldset>
          <button class="button">
            Submit
          </button>
        </fieldset>
      </form>      
        
      <!--<h3>Add a comment</h3>
      <form method="post" action="/.netlify/functions/staticman?branch=main">
        <p>
          <label for="name">Name</label>
          <br>
          <input id="name" type="text" name="fields[name]" placeholder="George P. Burdell">
    	</p>

        <p>
          <label for="message">Comment</label>
          <br>
          <textarea id="message" name="fields[message]" placeholder="Here's the thing..."></textarea>
        </p>

        <input type="hidden" name="fields[post]" value="{{ .Slug }}">
        <input type="hidden" name="options[redirect]" value="/thankyou">
        <input type="hidden" name="options[redirectError]" value="/error">

        <p>
          <button type="submit">Submit</button>
        </p>
      </form>-->
        
    </section>
  {{ end }}
{{ end }}
